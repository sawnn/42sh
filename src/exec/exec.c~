/*
** EPITECH PROJECT, 2018
** exec
** File description:
** a
*/

#include "../../include/my_sh.h"

void	print_segfault(int ret, t_mini *mini)
{
	if (WTERMSIG(ret) == 11) {
		put_msg(2, "Segmentation fault");
		if (WCOREDUMP(ret))
			put_msg(2, " (core dumped)");
		write(2, "\n", 1);
		mini->global = 139;
	}
	if (WTERMSIG(ret) == 8) {
		put_msg(2, "Floating exception");
		if (WCOREDUMP(ret))
			put_msg(2, " (core dumped)");
		write(2, "\n", 1);
		mini->global = 136;
	}
}

int	print_errno(t_mini *mini)
{
	if (errno == EACCES) {
		write(2, mini->tab[0], my_strlen(mini->tab[0]));
		put_msg(2, ": Permission denied.\n");
		mini->global = 1;
	}
	if (errno == ENOEXEC) {
		write(2, mini->tab[0], my_strlen(mini->tab[0]));
		put_msg(2, ": Exec format error.");
		put_msg(2, " Wrong Architecture.\n");
		mini->global = 1;
	}
	return (mini->global);
}

int	my_exec(t_mini *mini)
{
	pid_t	pid = fork();
	int	ret = 0;

	if (pid) {
		waitpid(pid, &ret, 0);
		mini->global = ret/256;
		print_segfault(ret, mini);
	}
	else {
		if (execve(mini->rpath, mini->tab, mini->env) == - 1)
			return (print_errno(mini));
	}
	return (mini->global);
}
